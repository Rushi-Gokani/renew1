{%- comment -%}
  Recipe Grid Section

  Features
  - Optional heading and subheading
  - Search input to filter by title/description
  - Tag filters (chips) generated from block tags
  - Responsive grid with image, title, excerpt, and time badge
  - Fully customizable via schema settings and blocks

  Best practices
  - Namespaced classes to avoid collisions
  - No global JS; all scoped with data attributes
  - Accessible labels and buttons
  - Uses "image" picker for performance and proper sizes
{%- endcomment -%}

{%- liquid
  assign section_id = section.id
  assign heading = section.settings.heading
  assign subheading = section.settings.subheading
  assign show_search = section.settings.show_search
  assign show_tags = section.settings.show_tags
  assign cards_per_row_desktop = section.settings.cards_per_row_desktop
  assign cards_per_row_mobile = section.settings.cards_per_row_mobile
  assign enable_time_badge = section.settings.enable_time_badge
  assign enable_equal_heights = section.settings.enable_equal_heights
  assign source_blog = section.settings.source_blog
  assign articles_limit = section.settings.articles_limit | default: 6
  if source_blog
    assign articles = source_blog.articles | slice: 0, articles_limit
    assign articles_count = articles.size
  endif
-%}

<section class="recipe-grid" id="recipe-grid-{{ section_id }}" data-section-id="{{ section_id }}">
  <div class="recipe-grid__container page-width" style="--recipe-max-width: {{ section.settings.container_width | default: 1200 }}px">
    {%- if heading != blank -%}
      <h2 class="recipe-grid__heading h1">{{ heading }}</h2>
    {%- endif -%}
    {%- if subheading != blank -%}
      <p class="recipe-grid__subheading subtitle">{{ subheading }}</p>
    {%- endif -%}

    {%- if show_search or show_tags -%}
      <div class="recipe-grid__controls" data-controls>
        {%- if show_search -%}
          <div class="recipe-grid__search">
            <label class="visually-hidden" for="recipe-search-{{ section_id }}">{{ 'general.search.search' | t }}</label>
            <input id="recipe-search-{{ section_id }}" type="search" class="field__input" placeholder="{{ section.settings.search_placeholder | default: 'Search recipes (e.g. smoothie, pasta)' }}" data-search-input>
          </div>
        {%- endif -%}

        {%- if show_tags and source_blog and articles_count != 0 -%}
          {%- assign all_tags = '' -%}
          {%- for article in articles -%}
            {%- for tag in article.tags -%}
              {%- assign tag_trim = tag | strip -%}
              {%- unless all_tags contains tag_trim -%}
                {%- assign all_tags = all_tags | append: tag_trim | append: '|' -%}
              {%- endunless -%}
            {%- endfor -%}
          {%- endfor -%}
          {%- assign tag_list = all_tags | split: '|' | uniq | sort -%}

          <div class="recipe-grid__tags" role="tablist" aria-label="Recipe filters" data-tag-list>
            <button class="recipe-grid__tag is-active" data-tag="all" aria-selected="true">{{ section.settings.all_label | default: 'All' }}</button>
            {%- for tag in tag_list -%}
              {%- if tag != blank -%}
                <button class="recipe-grid__tag" data-tag="{{ tag | escape }}" aria-selected="false">{{ tag }}</button>
              {%- endif -%}
            {%- endfor -%}
          </div>
        {%- endif -%}
      </div>
    {%- endif -%}

    <ul class="recipe-grid__list" data-grid style="--columns-desktop: {{ cards_per_row_desktop }}; --columns-mobile: {{ cards_per_row_mobile }};">
      {%- if source_blog and articles_count != 0 -%}
        {%- for article in articles -%}
          {%- assign tag_attr = '' -%}
          {%- for tag in article.tags -%}
            {%- assign tag_attr = tag_attr | append: tag | strip | handle | append: ' ' -%}
          {%- endfor -%}
          {%- assign time_text = '' -%}
          {%- if article.metafields.custom.time != blank -%}
            {%- assign time_text = article.metafields.custom.time -%}
          {%- else -%}
            {%- for t in article.tags -%}
              {%- if time_text == '' and t contains 'min' -%}
                {%- assign time_text = t -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
          <li class="recipe-card" data-recipe data-tags="{{ tag_attr | strip }}">
            <a href="{{ article.url }}" class="recipe-card__link" aria-label="{{ article.title | escape }}">
              {%- if article.image != blank -%}
                <span class="recipe-card__image-link">
                  {{ article.image | image_url: width: 1200 | image_tag: loading: 'lazy', class: 'recipe-card__image', widths: '600,900,1200', sizes: '(min-width: 990px) 33vw, 100vw', alt: article.image.alt | default: article.title }}
                  {%- if enable_time_badge and time_text != '' -%}
                    <span class="recipe-card__time" aria-label="{{ time_text | escape }}">‚è± {{ time_text }}</span>
                  {%- endif -%}
                </span>
              {%- endif -%}
              <div class="recipe-card__content" style="{%- if enable_equal_heights -%}min-height:6rem;{%- endif -%}">
                <h3 class="recipe-card__title">{{ article.title }}</h3>
                <p class="recipe-card__excerpt">{{ article.excerpt | default: article.excerpt_or_content | strip_html | truncate: 140 }}</p>
              </div>
            </a>
          </li>
        {%- endfor -%}
      {%- else -%}
        <li class="recipe-card" aria-live="polite">No articles found.</li>
      {%- endif -%}
    </ul>
  </div>

  <style>
    #recipe-grid-{{ section_id }} .recipe-grid__container{text-align:center;max-width:var(--recipe-max-width);margin-inline:auto}
    #recipe-grid-{{ section_id }} .recipe-grid__heading{margin:0 0 .25rem; font-size:50px;}
    #recipe-grid-{{ section_id }} .recipe-grid__subheading{margin:0 0 1.25rem;color:rgb(var(--color-foreground),.75)}
    #recipe-grid-{{ section_id }} .recipe-grid__controls{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center;justify-content:center;margin-block:1rem}
    #recipe-grid-{{ section_id }} .recipe-grid__search{flex:1 1 280px;max-width:520px}
    #recipe-grid-{{ section_id }} .recipe-grid__tags{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center}
    #recipe-grid-{{ section_id }} .recipe-grid__tag{border-radius:999px;border:1px solid rgb(var(--color-border));padding:.5rem .9rem;background:#fff;cursor:pointer;color:#111}
    #recipe-grid-{{ section_id }} .recipe-grid__tag.is-active{background:#34D399;border-color:#34D399;color:#fff}
    #recipe-grid-{{ section_id }} [data-grid]{display:grid;gap:1rem;grid-template-columns:repeat(var(--columns-mobile),minmax(0,1fr));margin-top:1rem}
    @media screen and (min-width: 990px){#recipe-grid-{{ section_id }} [data-grid]{grid-template-columns:repeat(var(--columns-desktop),minmax(0,1fr))}}
    #recipe-grid-{{ section_id }} .recipe-card{list-style:none;border:1px solid rgb(var(--color-border));border-radius:.75rem;overflow:hidden;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.04)}
    #recipe-grid-{{ section_id }} .recipe-card__link{display:block;color:inherit;text-decoration:none}
    #recipe-grid-{{ section_id }} .recipe-card__image-link{position:relative;display:block;aspect-ratio:16/9}
    #recipe-grid-{{ section_id }} .recipe-card__image{width:100%;height:100%;object-fit:cover;display:block}
    #recipe-grid-{{ section_id }} .recipe-card__time{position:absolute;top:.6rem;right:.6rem;background:rgba(0,0,0,.6);border-radius:999px;padding:.25rem .5rem;font-size:.8rem;color:#fff;border:1px solid rgba(255,255,255,.2)}
    #recipe-grid-{{ section_id }} .recipe-card__content{padding:1rem 1rem 1.1rem}
    #recipe-grid-{{ section_id }} .recipe-card__title{margin:0 0 .25rem;font-size:1rem;font-weight:700}
    #recipe-grid-{{ section_id }} .recipe-card__excerpt{margin:0;color:rgb(var(--color-foreground),.8);font-size:.95rem}
  </style>

  <script>
    (function(){
      var root = document.getElementById('recipe-grid-{{ section_id }}');
      if(!root) return;
      var input = root.querySelector('[data-search-input]');
      var tagList = root.querySelector('[data-tag-list]');
      var grid = root.querySelector('[data-grid]');
      var cards = grid ? Array.prototype.slice.call(grid.querySelectorAll('[data-recipe]')) : [];
      var activeTag = 'all';

      function normalize(text){return (text||'').toString().toLowerCase()}

      function applyFilters(){
        var q = normalize(input && input.value);
        cards.forEach(function(card){
          var title = normalize(card.querySelector('.recipe-card__title')?.textContent);
          var excerpt = normalize(card.querySelector('.recipe-card__excerpt')?.textContent);
          var tags = normalize(card.getAttribute('data-tags'));
          var textMatch = !q || title.indexOf(q) > -1 || excerpt.indexOf(q) > -1;
          var tagMatch = activeTag === 'all' || (tags && tags.indexOf(normalize(activeTag)) > -1);
          card.style.display = (textMatch && tagMatch) ? '' : 'none';
        });
      }

      if(input){ input.addEventListener('input', applyFilters); }

      if(tagList){
        tagList.addEventListener('click', function(e){
          var btn = e.target.closest('button[data-tag]');
          if(!btn) return;
          activeTag = btn.getAttribute('data-tag');
          Array.prototype.forEach.call(tagList.querySelectorAll('button[data-tag]'), function(el){
            el.classList.toggle('is-active', el === btn);
            el.setAttribute('aria-selected', el === btn ? 'true' : 'false');
          });
          applyFilters();
        });
      }

      // initial
      applyFilters();
    })();
  </script>
</section>

{% schema %}
{
  "name": "Recipe grid",
  "class": "section-recipe-grid",
  "settings": [
    {"type":"text","id":"heading","label":"Heading","default":"Discover Our Recipes"},
    {"type":"textarea","id":"subheading","label":"Subheading","default":"Explore our collection of delicious and nutritious recipes."},
    {"type":"checkbox","id":"show_search","label":"Enable search","default":false},
    {"type":"text","id":"search_placeholder","label":"Search placeholder","default":"Search for recipes like 'smoothie' or 'pasta'"},
    {"type":"blog","id":"source_blog","label":"Source blog"},
    {"type":"range","id":"articles_limit","label":"Articles to show","min":3,"max":12,"step":3,"default":6},
    {"type":"checkbox","id":"show_tags","label":"Enable tag filters","default":true},
    {"type":"text","id":"all_label","label":"All label","default":"All"},
    {"type":"range","id":"cards_per_row_desktop","label":"Cards per row (desktop)","min":2,"max":4,"step":1,"default":3},
    {"type":"range","id":"cards_per_row_mobile","label":"Cards per row (mobile)","min":1,"max":3,"step":1,"default":1},
    {"type":"checkbox","id":"enable_time_badge","label":"Show time badge","default":true},
    {"type":"checkbox","id":"enable_equal_heights","label":"Equalize card content heights","default":false},
    {"type":"range","id":"container_width","label":"Max width (px)","min":960,"max":1440,"step":60,"default":1200}
  ],
  "blocks": [],
  "presets": [
    {
      "name": "Recipe grid",
      "category": "Content",
      "settings": {}
    }
  ]
}
{% endschema %}

{% stylesheet %}
/* Intentionally left blank; styles are inlined per-section to scope */
{% endstylesheet %}

{% javascript %}
/* Intentionally left blank; JS is inlined above to keep scope to this section */
{% endjavascript %}


